<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>Quiz Game</title>
        <script src="bower_components/phaser/build/phaser.min.js"></script>
        <script src="bower_components/phaser/build/custom/phaser-arcade-physics.min.js"></script>
        
    </head>
    <body>
        <script>
            window.onload = function() {
            	
            	var questionsGame;
            	var answersPage;

            	var default_position_x =450;
            	var default_position_y = 300;
            	var background_color='#FFFFFF';
            	
            	var data;
            	
            	
            	var lives;
            	var hearts = [];
            	
            	
            	var category = 0;
            	var stage = -1;
            	
            	var mario_lose_audio;
            	var mario_haha;

            	var window_width = window.innerWidth-50;
            	var window_height = window.innerHeight-50;
                var game = new Phaser.Game(window_width, window_height, Phaser.AUTO, '', { preload: preload,create:create,update:update });

				
                function preload () {
                	game.load.pack('images_questions', 'assets/images-pack.json', null, this);
                	game.load.image('button', 'assets/button.png');
                	game.load.image('buttonNext', 'assets/buttonNext.png');
                	
                	game.load.image('heart', 'assets/heart.png');
                	game.load.image('right', 'assets/right.png');
                	game.load.image('wrong', 'assets/wrong.png');
                	game.load.json('questions', location.origin+'/data/questions.json');
                	game.load.audio('mario_lose', "assets/audios/sm64_mario_hurt.wav");
                	game.load.audio('mario_haha', "assets/audios/sm64_mario_haha.wav");
                	game.load.audio('game_over', "assets/audios/sm64_game_over.wav");
                	game.load.audio('yippee', "assets/audios/sm64_mario_yippee.wav");
                }
					
				function create () {
					questionsGame = new QuestionsGame();
					answersPage = new AnswersPage();
					data = game.cache.getJSON('questions');					
					lives = data.lives;

					mario_lose_audio = game.add.audio('mario_lose');
					mario_haha = game.add.audio('mario_haha');
					game_over = game.add.audio('game_over');
					yippee = game.add.audio('yippee');

					game.stage.backgroundColor = background_color;
					intro();
				}

				function intro(){
					var components = [];

					createTextCategory('7 - 10 years old',0);
					createTextCategory('10 - 13 years old',1);
					createTextCategory('13 - 17 years old',2);

					createTextHeaders('Welcome on board!',0);
					createTextHeaders('Let\'s test your skills',1);
					createTextHeaders('Choose your age!',2);

					function createTextCategory(text,index){
						var style = getStyleCategory();

						var textCategory = game.add.text(100+300+index*440,default_position_y+ 250,text, style);
						textCategory.category = index;
					    textCategory.anchor.set(0.5,0.5);
					    textCategory.inputEnabled = true;
					    textCategory.events.onInputDown.add(categoryTextClicked, game);
					    components.push(textCategory);
					    
					}

					function categoryTextClicked(item){
						category = item.category;
						for(var index in components){
							components[index].destroy();
						}
						startQuestions();
					}

					function createTextHeaders(text,index){
						var style = getStyleCategory();
						style.backgroundColor = background_color;
						style.fill= '#000000';
						var textComponent = game.add.text(window_width/2,200+index*100,text, style);
						textComponent.anchor.set(0.5,0.5);
						components.push(textComponent);
					}

					function getStyleCategory(){
						return { 
							font: "38pt Arial", fill: "#000000", wordWrap: false,  align: "left", backgroundColor:'#FFFFFF' };
					}

				}

				

				function QuestionsGame(){
					var image_question;
					var texts = [];
					var buttons = [];


					return {
						render:render,
						getQuestions:getQuestions,
						clear:clear,
					};


					function render(){
						stage = getStage();
						var question = getQuestions()[stage];
						addImageQuestion(stage);
						createTextTitle(question.question,-1);

						for(var index in question.choices){
								var choice = question.choices[index];
								createText(choice,index);
								createButtonChoice(index,question.answer,question.answer_description);
						}
					}

					function getQuestions(){
						return data.categories[category].questions;
					}

					function addImageQuestion(index){
						image_question = game.add.image(window_width/2,default_position_y-50, 'image_question_'+category+'_'+index);
						image_question.anchor.set(0.5,0.5);
						var fixedHeight = 400;
						
							
						if(image_question.height>fixedHeight){
							var height = image_question.height;
							var scale = calcScale(height,fixedHeight);
							image_question.scale.set(scale);
						}
						
					}

					function createTextTitle(text,index){
						var style = getStyle();
						var text = game.add.text(window_width/2,default_position_y+ 250+index*80,text, style);
					    text.anchor.set(0.5,0.5);
					    texts.push(text);
					}

					function createText(text,index){
						var style = getStyle();
						var text = game.add.text(default_position_x+100,default_position_y+ 250+index*80,text, style);
					    text.anchor.set(0,0.5);
					    texts.push(text);
					}

					function createButtonChoice(index,answer,answer_description){
					
						var button = game.add.button(default_position_x+30,default_position_y+ 220+index*80, 'button', buttonChoiceClicked, this, 2, 1, 0);
						button.index = index;
						button.answer = answer;
						button.answer_description = answer_description;

						button.input.useHandCursor = true;
						button.scale.setTo(0.50,0.50);
						buttons.push(button);
					}

					function clear(){
						image_question.destroy();
						for(var i in texts){
					    	texts[i].destroy();
					    }
					    for(var i in buttons){
					    	buttons[i].destroy();
					    }
					    
					    texts = [];
					}
				}

				function startQuestions(){
					questionsGame.render()
					createLives();
				}

				
				function AnswersPage(){
					var text_answer_is;
					var image_answer;
					var image_right_wrong;
					var buttonNexts = [];
					var text_answers = [];
					var buttonNext;

					return {
						render:render,
						clear:clear};

					function render(right){
						createImageAnswer();
						createTextTitleAnswer('This is the answer!');
						createButtonNext();
						createRightWrong(right);
					}


					function createImageAnswer(){
						addImageAnswer(stage);
					}

					function createTextTitleAnswer(text){
						var style = getStyle();
						text_answer_is = game.add.text(window_width/2,30,text, style);
					    text_answer_is.anchor.set(0.5,0.5);
					}
					
					function addImageAnswer(index){
						image_answer = game.add.image(window_width/2,default_position_y-50, 'image_answer_'+category+'_'+index);
						image_answer.anchor.set(0.5,0.5);
						var fixedHeight = 400;
						var height = image_answer.height;
							var scale = calcScale(height,fixedHeight);
							image_answer.scale.set(scale);
					}

		
					function createRightWrong(right){					
						var imageName = 'right';
						if(!right){
							var imageName = 'wrong';
						}
						image_right_wrong = game.add.image(window_width/2,image_answer.height/2+default_position_y+180, imageName);
						image_right_wrong.anchor.set(0.5,0.5);
					    //image_right_wrong.scale.set(0.5,0.5);
					}

					function clear(){
						for(var i in buttonNexts){
					    	buttonNexts[i].destroy();
					    }

					    for(var i in text_answers){
					    	text_answers[i].destroy();
					    }

					    image_answer.destroy();
					    text_answer_is.destroy();
					    image_right_wrong.destroy();
					    
					    buttonNexts = [];
					    text_answers = [];
					}

					function createButtonNext(index){
					
						buttonNext = game.add.button(window_width-100,window_height-100, 'buttonNext', buttonNextClicked, this, 2, 1, 0);
						buttonNext.index = index;

						buttonNext.input.useHandCursor = true;
						buttonNext.scale.setTo(1.50,1.50);
						buttonNext.anchor.set(0.5,0.5);
						buttonNexts.push(buttonNext);
					}
				}


				function getStage(){
					stage++;
					return stage;
				}

				function buttonChoiceClicked(button) {
					var right = true;
				    if(button.index == button.answer){
				    	if(stage<questionsGame.getQuestions().length-1){
					    	mario_haha.play();	
					    }


				    }else{
				    	right = false;
				    	if(lives>0){
							loseLife();
						}else{
							game_over.play();
							questionsGame.clear();
							endGameLose();
							return;
						}

				    	mario_lose_audio.play();
				    }
						
				    var answer_description = button.answer_description;
				    questionsGame.clear();
					answersPage.render(right);				    
				}

				function buttonNextClicked(){
					answersPage.clear();
					if(stage<questionsGame.getQuestions().length-1){
				    	questionsGame.render();	
				    }else{
				    	endGameWin();
				    	yippee.play();
				    }
				}

				
				function loseLife(){
					if(lives>0){
						var heart = hearts.pop();
						heart.destroy();
						lives--;	
					}else{
						questionsGame.clear();
						endGameWin();
					}
				}

				function update()
				{

				}

				function endGameWin(){
					var style = { 
						font: "20pt Arial", fill: "#000000", wordWrap: false,  align: "center", backgroundColor: background_color };

					var text = game.add.text(window_width/2,window_height/2,'YOU WIN!!', style);
				    text.anchor.set(0.5,0.5);
				}

				function endGameLose(){
					var style = { 
						font: "20pt Arial", fill: "#000000", wordWrap: false,  align: "center", backgroundColor: background_color };
					
					var text = game.add.text(window_width/2,window_height/2,'Game Over!!', style);
				    text.anchor.set(0,0.5);
				}

				function getStyle(){
					return { 
						font: "28pt Arial", fill: "#000000", wordWrap: false,  align: "left", backgroundColor: background_color };

				}


				function calcScale(height,fixedHeight){
					return fixedHeight/height;
				}
				
				
				function createLives(){
					for (var i = 0; i < lives; i++) {
						var heart = game.add.sprite(default_position_x+1100-i*80,default_position_y -300, 'heart');
						heart.scale.setTo(1.25,1.25);
						hearts.push(heart);    
					}
				}				
            };
        </script>
    </body>
</html>